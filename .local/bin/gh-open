#!/usr/bin/env pwsh
$owner,$repo=$(([Uri]$(git remote get-url origin)).PathAndQuery | Select-String -Pattern '\/([^\/]*)\/([^\/\.]*)').Matches.Groups | ? Name -ne 0 | % Value


$token=(Get-Content ~/.config/gh/hosts.yml | ConvertFrom-Yaml).'github.com'.oauth_token
$headers = @{ Authorization = "token $token" }

$protection = @{
  restrictions = @{
    users = @()
    teams = @()
    apps = @()
  }
  required_pull_request_reviews = @{
    dismiss_stale_reviews = $true
    require_code_owner_reviews = $true
    dismissal_restrictions = @{
      users = @()
      teams = @()
    }
  }
  enforce_admins = $false
  required_status_checks = $null
}

$BranchName = (Get-GitStatus).Branch

(Invoke-RestMethod -Headers $headers "https://api.github.com/repos/$owner/$repo/branches/$BranchName").where{ $_.protected -eq $True } | % {
  Write-Host "Opening $BranchName branch for $owner/$repo"
  Invoke-RestMethod -Headers $headers -Method Put -Body ($protection | ConvertTo-Json -Depth 10) "https://api.github.com/repos/$owner/$repo/branches/$BranchName/protection" | Out-Null
}
