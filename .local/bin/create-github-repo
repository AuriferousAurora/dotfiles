#!/usr/bin/env pwsh
[CmdletBinding()]
param (
    [Parameter()]
    [String]
    $Name,

    [Parameter()]
    [String]
    $Team,

    [Parameter()]
    [String]
    $JenkinsUrl = 'https://cicd-tools.eops.prd.gcp.efx/iaas-cs-ci-jenkins/'
)

if (-Not $env:GITHUB_TOKEN -and (Test-Path ~/.config/gh/hosts.yml)) {
  $env:GITHUB_TOKEN = (Get-Content ~/.config/gh/hosts.yml | ConvertFrom-Yaml).'github.com'.oauth_token
}
$headers = @{ Authorization = "token $($env:GITHUB_TOKEN)" }

if (-Not $Name) {
  $path = Get-Location
  $Name = $path | Split-Path -Leaf
  Write-Host "Name parameter not specified, using -Name $Name"
}
else {
  $path = Join-Path (Get-Location) $Name
}

if (-Not (Test-Path $path)) {
  throw "$path does not exist"
}

Push-Location $path
try {
  # Make sure code is checked in
  $status = Get-GitStatus
  if (-Not $status) {
    throw "No git repository found at $path"
  }

  if ($status.HasUntracked) {
    throw "Repository has uncommited files.  Please make sure the local repository is up to date before creating a remote repo"
  }

  $parent = $path | Split-Path -Parent | Split-Path -Leaf
  $repo_name = "$($parent)-$Name"
  $repo_url = "https://github.com/Equifax/$repo_name.git"

  $remote = git remote get-url origin 2>$null

  if (-Not $remote) {
    if (-Not $Team) {
      $Team = $parent
      Write-Host "Team parameter not specified, using -Team $Team"
    }

    # Check if team exists
    if (-Not (Invoke-RestMethod -Headers $headers -Uri "https://api.github.com/orgs/Equifax/teams/$Team" -SkipHttpErrorCheck).slug) {
      throw "Team $Team not found in the Equifax organization"
    }


    if ($(git remote)) {
      git fetch --all
    }
    gh repo create Equifax/$repo_name --internal --confirm --team $team
    git push --set-upstream origin main
    git push -f --mirror origin
  }
  else {
    Write-Warning "Remote GitHub repo already exists at $remote"
  }

  # Build a uri that prefills all of these value for a CICD ticket

  Write-Host "Link to Self Service Job to add repo to GitHub application"
  Write-Host 'https://cicd-tools.eops.prd.gcp.efx/cicd-mbps-jenkins/job/public_jobs/job/cicd_self_service_Add_GithubRepo_to_GithubApp/build?delay=0sec'
  Write-Host ''
  Write-Host "https://github.com/Equifax/$repo_name.git"
}
catch {
  Write-Error $_
  exit 1
}
finally {
  Pop-Location
}